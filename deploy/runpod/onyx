#!/bin/bash
# Onyx Pipeline CLI for RunPod
# Usage: ./onyx <command> [args]

set -e

IMAGE="ghcr.io/aenoriss/onyx-pipeline:v1"
MASK_IMAGE="ghcr.io/aenoriss/segformer-mask:v1"
CONTAINER_NAME="onyx"
WORKSPACE="/workspace"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

print_help() {
    echo "Onyx Pipeline CLI"
    echo ""
    echo "Usage: ./onyx <command> [options]"
    echo ""
    echo "Commands:"
    echo "  pull              Pull Docker images from ghcr.io"
    echo "  shell             Start interactive shell in container"
    echo "  extract           Run 360Extractor on a video"
    echo "  sfm               Run InstantSfM on extracted frames"
    echo "  mask              Run Grounded-SAM-2 to generate masks"
    echo "  pipeline          Run full pipeline (extract + sfm + mask)"
    echo "  status            Show container and GPU status"
    echo "  stop              Stop running container"
    echo "  logs              Show container logs"
    echo ""
    echo "Examples:"
    echo "  ./onyx pull"
    echo "  ./onyx shell"
    echo "  ./onyx extract --input /data/video.mp4 --output /data/scene1/frames"
    echo "  ./onyx sfm --scene /data/scene1"
    echo "  ./onyx mask --scene /data/scene1"
    echo "  ./onyx pipeline --input /data/video.mp4 --scene /data/scene1"
}

cmd_pull() {
    echo -e "${GREEN}Pulling Onyx Pipeline image...${NC}"
    docker pull $IMAGE
    echo ""
    echo -e "${GREEN}Pulling Grounded-SAM-2 image...${NC}"
    docker pull $MASK_IMAGE
}

cmd_shell() {
    local MOUNTS=""

    # Mount /data if it exists (common on RunPod)
    if [ -d "/data" ]; then
        MOUNTS="$MOUNTS -v /data:/data"
    fi

    # Mount scenes directory if it exists
    if [ -d "./scenes" ]; then
        MOUNTS="$MOUNTS -v $(pwd)/scenes:$WORKSPACE/scenes"
    fi

    echo -e "${GREEN}Starting interactive shell...${NC}"
    docker run --gpus all -it --rm \
        --name $CONTAINER_NAME \
        --shm-size=16g \
        $MOUNTS \
        $IMAGE \
        /bin/bash
}

cmd_extract() {
    local INPUT=""
    local OUTPUT=""
    local INTERVAL="1.0"
    local CAMERAS="12"
    local LAYOUT="fibonacci"
    local RESOLUTION="1024"

    while [[ $# -gt 0 ]]; do
        case $1 in
            --input|-i) INPUT="$2"; shift 2 ;;
            --output|-o) OUTPUT="$2"; shift 2 ;;
            --interval) INTERVAL="$2"; shift 2 ;;
            --cameras) CAMERAS="$2"; shift 2 ;;
            --layout) LAYOUT="$2"; shift 2 ;;
            --resolution) RESOLUTION="$2"; shift 2 ;;
            *) echo "Unknown option: $1"; exit 1 ;;
        esac
    done

    if [ -z "$INPUT" ] || [ -z "$OUTPUT" ]; then
        echo -e "${RED}Error: --input and --output are required${NC}"
        echo "Usage: ./onyx extract --input /path/to/video.mp4 --output /path/to/frames"
        exit 1
    fi

    echo -e "${GREEN}Running 360Extractor...${NC}"
    echo "  Input: $INPUT"
    echo "  Output: $OUTPUT"
    echo "  Interval: ${INTERVAL}s, Cameras: $CAMERAS, Layout: $LAYOUT"

    docker run --gpus all --rm \
        --name ${CONTAINER_NAME}-extract \
        --shm-size=16g \
        -v "$(dirname $INPUT):$(dirname $INPUT)" \
        -v "$(dirname $OUTPUT):$(dirname $OUTPUT)" \
        $IMAGE \
        python /workspace/360Extractor/src/main.py \
            --input "$INPUT" \
            --output "$OUTPUT" \
            --interval "$INTERVAL" \
            --camera-count "$CAMERAS" \
            --layout "$LAYOUT" \
            --resolution "$RESOLUTION" \
            --format png
}

cmd_sfm() {
    local SCENE=""

    while [[ $# -gt 0 ]]; do
        case $1 in
            --scene|-s) SCENE="$2"; shift 2 ;;
            *) echo "Unknown option: $1"; exit 1 ;;
        esac
    done

    if [ -z "$SCENE" ]; then
        echo -e "${RED}Error: --scene is required${NC}"
        echo "Usage: ./onyx sfm --scene /path/to/scene"
        exit 1
    fi

    COLMAP_DIR="$SCENE/colmap"

    # Check if colmap/images exists
    if [ ! -d "$COLMAP_DIR/images" ]; then
        echo -e "${YELLOW}Creating colmap structure...${NC}"
        mkdir -p "$COLMAP_DIR/images"

        # Link frames to colmap/images if frames directory exists
        if [ -d "$SCENE/frames" ]; then
            echo "Linking frames to colmap/images..."
            ln -sf "$SCENE/frames"/*.png "$COLMAP_DIR/images/" 2>/dev/null || \
            ln -sf "$SCENE/frames"/*.jpg "$COLMAP_DIR/images/" 2>/dev/null || true
        fi
    fi

    echo -e "${GREEN}Running InstantSfM...${NC}"
    echo "  Scene: $COLMAP_DIR"

    docker run --gpus all --rm \
        --name ${CONTAINER_NAME}-sfm \
        --shm-size=16g \
        -v "$SCENE:$SCENE" \
        $IMAGE \
        bash -c "ins-feat --data_path $COLMAP_DIR --single_camera && ins-sfm --data_path $COLMAP_DIR --export_txt"
}

cmd_mask() {
    local SCENE=""
    local PROMPT="sky. ocean. sea. water. person. car. boat. bird."

    while [[ $# -gt 0 ]]; do
        case $1 in
            --scene|-s) SCENE="$2"; shift 2 ;;
            --prompt|-p) PROMPT="$2"; shift 2 ;;
            *) echo "Unknown option: $1"; exit 1 ;;
        esac
    done

    if [ -z "$SCENE" ]; then
        echo -e "${RED}Error: --scene is required${NC}"
        echo "Usage: ./onyx mask --scene /path/to/scene [--prompt 'sky. water.']"
        exit 1
    fi

    COLMAP_DIR="$SCENE/colmap"
    IMAGES_DIR="$COLMAP_DIR/images"
    MASKS_DIR="$COLMAP_DIR/masks"

    if [ ! -d "$IMAGES_DIR" ]; then
        echo -e "${RED}Error: Images directory not found: $IMAGES_DIR${NC}"
        echo "Run 'onyx sfm' first to create the colmap structure."
        exit 1
    fi

    echo -e "${GREEN}Running Grounded-SAM-2...${NC}"
    echo "  Images: $IMAGES_DIR"
    echo "  Output: $MASKS_DIR"
    echo "  Prompt: $PROMPT"

    docker run --gpus all --rm \
        --name ${CONTAINER_NAME}-mask \
        --shm-size=16g \
        -v "$SCENE:$SCENE" \
        $MASK_IMAGE \
        --input "$IMAGES_DIR" \
        --output "$MASKS_DIR" \
        --prompt "$PROMPT"
}

cmd_pipeline() {
    local INPUT=""
    local SCENE=""
    local INTERVAL="1.0"
    local CAMERAS="12"

    while [[ $# -gt 0 ]]; do
        case $1 in
            --input|-i) INPUT="$2"; shift 2 ;;
            --scene|-s) SCENE="$2"; shift 2 ;;
            --interval) INTERVAL="$2"; shift 2 ;;
            --cameras) CAMERAS="$2"; shift 2 ;;
            *) echo "Unknown option: $1"; exit 1 ;;
        esac
    done

    if [ -z "$INPUT" ] || [ -z "$SCENE" ]; then
        echo -e "${RED}Error: --input and --scene are required${NC}"
        echo "Usage: ./onyx pipeline --input /path/to/video.mp4 --scene /path/to/scene"
        exit 1
    fi

    FRAMES_DIR="$SCENE/frames"

    echo -e "${GREEN}=== ONYX PIPELINE ===${NC}"
    echo ""

    # Stage 1: Extract
    echo -e "${YELLOW}[1/3] 360Extractor${NC}"
    cmd_extract --input "$INPUT" --output "$FRAMES_DIR" --interval "$INTERVAL" --cameras "$CAMERAS"

    echo ""

    # Stage 2: SfM
    echo -e "${YELLOW}[2/3] InstantSfM${NC}"
    cmd_sfm --scene "$SCENE"

    echo ""

    # Stage 3: Masking
    echo -e "${YELLOW}[3/3] Grounded-SAM-2${NC}"
    cmd_mask --scene "$SCENE"

    echo ""
    echo -e "${GREEN}Pipeline complete!${NC}"
    echo "  Sparse model: $SCENE/colmap/sparse/0/"
    echo "  Masks: $SCENE/colmap/masks/"
}

cmd_status() {
    echo -e "${GREEN}=== GPU Status ===${NC}"
    nvidia-smi --query-gpu=name,memory.used,memory.total,utilization.gpu --format=csv,noheader 2>/dev/null || echo "No GPU found"

    echo ""
    echo -e "${GREEN}=== Docker Status ===${NC}"
    docker ps -a --filter "name=onyx" --format "table {{.Names}}\t{{.Status}}\t{{.Image}}"

    echo ""
    echo -e "${GREEN}=== Image ===${NC}"
    docker images $IMAGE --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}"
}

cmd_stop() {
    echo -e "${YELLOW}Stopping Onyx containers...${NC}"
    docker stop $(docker ps -q --filter "name=onyx") 2>/dev/null || echo "No running containers"
}

cmd_logs() {
    docker logs -f $CONTAINER_NAME 2>/dev/null || echo "No container running"
}

# Main
case "${1:-help}" in
    pull) cmd_pull ;;
    shell) cmd_shell ;;
    extract) shift; cmd_extract "$@" ;;
    sfm) shift; cmd_sfm "$@" ;;
    mask) shift; cmd_mask "$@" ;;
    pipeline) shift; cmd_pipeline "$@" ;;
    status) cmd_status ;;
    stop) cmd_stop ;;
    logs) cmd_logs ;;
    help|--help|-h) print_help ;;
    *) echo "Unknown command: $1"; print_help; exit 1 ;;
esac
